{"version":3,"file":"qrcodemodal.min.js","sources":["../src/qrcodemodal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Generate the QR code.\n *\n * @module     tiny_qrcode/qrcodemodal\n * @copyright  2024 Brain Station 23 Ltd. <brainstation-23.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n */\n\nimport Modal from 'core/modal';\nimport {component} from './common';\nimport AJAX from 'core/ajax';\n\nexport default class QrcodeModal extends Modal {\n\n    static TYPE = `${component}/qrcodemodal`;\n    static TEMPLATE = `${component}/insert_qrcode_modal`;\n\n    registerEventListeners() {\n        // Call the parent registration.\n        super.registerEventListeners();\n\n        const attachSubmitHandler = () => {\n            const qrcodeForm = window.document.getElementById('qrcode-submit');\n            if (qrcodeForm) {\n                if (!qrcodeForm.dataset.listenerAttached) {\n                    qrcodeForm.addEventListener( 'click', (event) => {\n                        event.preventDefault();\n                        const hexToRgba = (hex, alpha = 1) => {\n                            hex = hex.replace(/^#/, '');\n                            const bigint = parseInt(hex, 16);\n                            const r = (bigint >> 16) & 255;\n                            const g = (bigint >> 8) & 255;\n                            const b = bigint & 255;\n                            return {\n                                r: r,\n                                g: g,\n                                b: b,\n                                a: alpha\n                            };\n                        };\n                        // Prepare form data for submission\n                        const formData = {\n                            content: document.querySelector('#qrcodecontent').value,\n                            size: parseInt(document.querySelector('#qrcode_size').value),\n                            margin: parseInt(document.querySelector('#qrcode_margin').value),\n                            bgColor: hexToRgba(\n                                document.querySelector('#bgtemplateColor').value,\n                                parseFloat(document.querySelector('#bgcolor_a')?.value || 1)\n                            ),\n                            fgColor: hexToRgba(\n                                document.querySelector('#templateColor').value,\n                                parseFloat(document.querySelector('#color_a')?.value || 1)\n                            ),\n                        };\n                        // Moodle AJAX call to web service\n                        AJAX.call([{\n                            methodname: 'tiny_qrcode_generate_qr_code',\n                            args: {data: JSON.stringify({\n                                content: formData.content,\n                                size: formData.size,\n                                margin: formData.margin,\n                                bgColor: formData.bgColor,\n                                fgColor: formData.fgColor,\n                            })},\n                            done: function(response) {\n                                if (response.status) {\n                                    const targetEditor = window.currentQRCodeEditor;\n                                    if (targetEditor) {\n                                        targetEditor.insertContent(`<img src=\"${response.datauri}\" alt=\"QR Code for ${formData.content}\" />`);\n                                    } else {\n                                        console.error('No target editor found');\n                                    }\n                                } else {\n                                    console.error('QR Code generation failed');\n                                }\n                                // Clean up the stored editor reference\n                                window.currentQRCodeEditor = null;\n                            },\n                            fail: function(ex) {\n                                console.error('Web service call failed', ex);\n                                // Clean up the stored editor reference\n                                window.currentQRCodeEditor = null;\n                            }\n                        }]);\n                        this.destroy();\n                    });\n                    qrcodeForm.dataset.listenerAttached = true;\n                }\n            } else {\n                console.warn('Form not found. Retrying...');\n                setTimeout(attachSubmitHandler, 500);\n            }\n        };\n        // Attach the submit handler\n        attachSubmitHandler();\n    }\n    configure(modalConfig) {\n        modalConfig.show = true;\n        super.configure(modalConfig);\n    }\n}\n"],"names":["QrcodeModal","Modal","registerEventListeners","attachSubmitHandler","qrcodeForm","window","document","getElementById","dataset","listenerAttached","addEventListener","event","preventDefault","hexToRgba","hex","alpha","replace","bigint","parseInt","r","g","b","a","formData","content","querySelector","value","size","margin","bgColor","parseFloat","fgColor","call","methodname","args","data","JSON","stringify","done","response","status","targetEditor","currentQRCodeEditor","insertContent","datauri","console","error","fail","ex","destroy","warn","setTimeout","configure","modalConfig","show","component"],"mappings":"ghBA4BqBA,oBAAoBC,eAKrCC,+BAEUA,+BAEAC,oBAAsB,WAClBC,WAAaC,OAAOC,SAASC,eAAe,iBAC9CH,WACKA,WAAWI,QAAQC,mBACpBL,WAAWM,iBAAkB,SAAUC,yDACnCA,MAAMC,uBACAC,UAAY,SAACC,SAAKC,6DAAQ,EAC5BD,IAAMA,IAAIE,QAAQ,KAAM,UAClBC,OAASC,SAASJ,IAAK,IACvBK,EAAKF,QAAU,GAAM,IACrBG,EAAKH,QAAU,EAAK,IACpBI,EAAa,IAATJ,aACH,CACHE,EAAGA,EACHC,EAAGA,EACHC,EAAGA,EACHC,EAAGP,QAILQ,SAAW,CACbC,QAASlB,SAASmB,cAAc,kBAAkBC,MAClDC,KAAMT,SAASZ,SAASmB,cAAc,gBAAgBC,OACtDE,OAAQV,SAASZ,SAASmB,cAAc,kBAAkBC,OAC1DG,QAAShB,UACLP,SAASmB,cAAc,oBAAoBC,MAC3CI,0CAAWxB,SAASmB,cAAc,4EAAeC,QAAS,IAE9DK,QAASlB,UACLP,SAASmB,cAAc,kBAAkBC,MACzCI,2CAAWxB,SAASmB,cAAc,4EAAaC,QAAS,mBAI3DM,KAAK,CAAC,CACPC,WAAY,+BACZC,KAAM,CAACC,KAAMC,KAAKC,UAAU,CACxBb,QAASD,SAASC,QAClBG,KAAMJ,SAASI,KACfC,OAAQL,SAASK,OACjBC,QAASN,SAASM,QAClBE,QAASR,SAASQ,WAEtBO,KAAM,SAASC,aACPA,SAASC,OAAQ,OACXC,aAAepC,OAAOqC,oBACxBD,aACAA,aAAaE,kCAA2BJ,SAASK,sCAA6BrB,SAASC,iBAEvFqB,QAAQC,MAAM,+BAGlBD,QAAQC,MAAM,6BAGlBzC,OAAOqC,oBAAsB,MAEjCK,KAAM,SAASC,IACXH,QAAQC,MAAM,0BAA2BE,IAEzC3C,OAAOqC,oBAAsB,cAGhCO,aAET7C,WAAWI,QAAQC,kBAAmB,IAG1CoC,QAAQK,KAAK,+BACbC,WAAWhD,oBAAqB,OAIxCA,sBAEJiD,UAAUC,aACNA,YAAYC,MAAO,QACbF,UAAUC,kEAtFHrD,6BAEAuD,mDAFAvD,iCAGIuD"}